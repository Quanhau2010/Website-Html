<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herlys GPT Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 flex flex-col h-screen">
    <!-- Thanh tiêu đề -->
    <div class="bg-blue-500 p-4 text-white text-center font-semibold">Chat GPT - Herlys</div>

    <!-- Các nút điều hướng -->
    <div class="flex justify-center space-x-4 p-4 bg-gray-200">
        <button id="newChatBtn" class="w-1/2 p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-all">Đoạn Chat Mới</button>
        <button id="historyChatBtn" class="w-1/2 p-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-all">Lịch Sử Chat</button>
        <button id="clearHistoryBtn" class="w-1/2 p-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-all">Xóa Lịch Sử</button>
    </div>

    <!-- Khung chat -->
    <div id="chat" class="flex-1 p-4 overflow-y-auto space-y-4">
        <!-- Lịch sử chat sẽ được hiển thị ở đây -->
    </div>

    <!-- Form gửi tin nhắn -->
    <form id="form" class="bg-white p-4 border-t-2 border-gray-300">
        <input type="text" id="input" class="w-full p-3 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Nhập câu hỏi..." required />
        <button type="submit" id="send" class="mt-2 w-full p-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-all">Gửi</button>
    </form>

    <script>
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const chat = document.getElementById('chat');
        const newChatBtn = document.getElementById('newChatBtn');
        const historyChatBtn = document.getElementById('historyChatBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');

        let currentChatName = ""; // Biến lưu tên đoạn chat hiện tại
        let currentChatMessages = []; // Biến lưu các tin nhắn trong đoạn chat hiện tại

        // Xóa tất cả lịch sử chat
        clearHistoryBtn.addEventListener('click', () => {
            localStorage.removeItem('chatHistory'); // Xóa lịch sử chat khỏi localStorage
            chat.innerHTML = ''; // Xóa các tin nhắn trong giao diện
        });

        // Load lịch sử chat từ localStorage khi tải trang
        function loadHistoryChat() {
            const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
            chat.innerHTML = '';  // Xóa chat hiện tại

            if (history.length === 0) {
                appendMessage('GPT', 'Chưa có đoạn chat nào.', 'bot');
                return; // Không hiển thị gì nếu không có lịch sử chat
            }

            // Hiển thị danh sách các đoạn chat
            const historyDiv = document.createElement('div');
            history.forEach((item, index) => {
                const chatLink = document.createElement('button');
                chatLink.classList.add('p-2', 'bg-gray-300', 'w-full', 'text-left', 'rounded-md', 'hover:bg-gray-400', 'transition-all');
                chatLink.innerText = `Đoạn chat ${index + 1}: ${item.firstMessage}`;
                chatLink.addEventListener('click', () => loadChatByIndex(index));
                historyDiv.appendChild(chatLink);
            });
            chat.appendChild(historyDiv);
        }

        // Mở cuộc trò chuyện mới
        function startNewChat() {
            chat.innerHTML = '';  // Xóa chat hiện tại
            input.focus(); // Đặt con trỏ vào ô nhập liệu
            currentChatName = ""; // Reset tên đoạn chat
            currentChatMessages = []; // Reset tin nhắn đoạn chat
        }

        // Lắng nghe sự kiện nút "Đoạn chat mới"
        newChatBtn.addEventListener('click', startNewChat);

        // Lắng nghe sự kiện nút "Lịch sử chat"
        historyChatBtn.addEventListener('click', loadHistoryChat);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (!text) return;

            // Nếu chưa có tên cho đoạn chat, đặt tên bằng tin nhắn đầu tiên
            if (!currentChatName) {
                currentChatName = text;
            }

            // Hiển thị tin nhắn người dùng
            appendMessage('Bạn', text, 'user');
            currentChatMessages.push({ sender: 'Bạn', text: text, className: 'user' });
            input.value = '';

            // Hiển thị thông báo "Bot đang trả lời..." (tạm thời)
            const botMessageDiv = appendMessage('GPT', 'Bot đang trả lời...', 'bot');
            currentChatMessages.push({ sender: 'GPT', text: 'Bot đang trả lời...', className: 'bot' });

            // Gửi request tới API
            try {
                const response = await fetch('https://keyherlyswar.x10.mx/Apidocs/gpt-4o-pro.php?ask=' + encodeURIComponent(text));
                const data = await response.json();

                // Cập nhật tin nhắn trả lời từ bot
                botMessageDiv.innerHTML = `<strong class="font-semibold">GPT:</strong> ${data.response}`;
                currentChatMessages[currentChatMessages.length - 1].text = data.response; // Cập nhật tin nhắn trả lời

                // Kiểm tra và hiển thị ảnh nếu có, ảnh sẽ được chèn ngay dưới tin nhắn của ChatGPT
                if (data.images && data.images.length > 0) {
                    data.images.forEach(imgUrl => {
                        appendImage(botMessageDiv, imgUrl); // Thêm ảnh dưới tin nhắn của ChatGPT
                    });
                }

                // Lưu trữ lịch sử chat vào localStorage
                const history = JSON.parse(localStorage.getItem('chatHistory')) || [];

                // Kiểm tra trùng đoạn chat (so sánh tin nhắn đầu tiên)
                const existingChatIndex = history.findIndex(chat => chat.firstMessage === currentChatName);
                if (existingChatIndex === -1) {
                    // Nếu chưa có cuộc trò chuyện, tạo mới
                    history.push({
                        firstMessage: currentChatName,  // Đặt tên đoạn chat là tin nhắn đầu tiên
                        messages: currentChatMessages
                    });
                    localStorage.setItem('chatHistory', JSON.stringify(history)); // Lưu lại lịch sử chat
                }
            } catch (error) {
                // Hiển thị lỗi nếu có
                appendMessage('GPT', 'Đã xảy ra lỗi, vui lòng thử lại.', 'bot');
                console.error('Error:', error);
            }
        });

        function appendMessage(sender, text, className) {
            const div = document.createElement('div');
            div.classList.add('flex', 'items-start', 'space-x-4');
            if (className === 'user') {
                div.classList.add('justify-end');
            }

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('p-3', 'max-w-xs', 'rounded-lg', 'shadow-md', 'bg-blue-100', 'text-gray-800');
            if (className === 'bot') {
                messageDiv.classList.add('bg-green-100');
            }

            messageDiv.innerHTML = `<strong class="font-semibold">${sender}:</strong> ${text}`;
            div.appendChild(messageDiv);
            chat.appendChild(div); // Thêm mới vào cuối để hiển thị từ trên xuống
            chat.scrollTop = chat.scrollHeight; // Auto scroll xuống cuối
            return messageDiv; // Trả về phần tử để có thể chèn ảnh dưới tin nhắn của ChatGPT
        }

        function appendImage(messageDiv, imgUrl) {
        const imageDiv = document.createElement('div');
        imageDiv.classList.add('flex', 'flex-col', 'items-center', 'mt-2');
        
        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = 'Image response from GPT';
        img.classList.add('max-w-xs', 'rounded-lg', 'shadow-md', 'mb-2');
        
        const saveButton = document.createElement('a');
        saveButton.href = imgUrl;
        
        // Tự động lấy tên file từ URL và thêm ".png" nếu không có đuôi
        let urlParts = imgUrl.split('/');
        let rawFileName = urlParts[urlParts.length - 1].split('?')[0]; // loại bỏ query string
        if (!rawFileName.includes('.')) {
        rawFileName += '.png'; // nếu không có đuôi thì thêm .png
        }
        
        saveButton.download = rawFileName;
        
        saveButton.textContent = 'Lưu ảnh';
        saveButton.classList.add('px-2', 'py-1', 'bg-blue-500', 'text-white', 'rounded-md', 'text-sm', 'hover:bg-blue-600',
        'transition-all');
        
        // Thêm thông báo yêu cầu thêm .png vào đuôi nếu người dùng lưu
        const infoText = document.createElement('p');
        infoText.classList.add('text-xs', 'text-yellow-500', 'mt-1'); // Màu vàng
        infoText.textContent = 'Nếu lưu ảnh, bạn phải thêm ".png" vào đuôi file ảnh để xem nhé.';
        
        imageDiv.appendChild(img);
        imageDiv.appendChild(saveButton);
        imageDiv.appendChild(infoText); // Thêm thông báo
        
        messageDiv.appendChild(imageDiv);
        chat.scrollTop = chat.scrollHeight;
        }

        // Hàm để load đoạn chat khi nhấn vào tên đoạn chat
        function loadChatByIndex(index) {
            const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
            const selectedChat = history[index].messages;
            chat.innerHTML = '';  // Xóa chat hiện tại

            // Hiển thị lại tất cả các tin nhắn trong đoạn chat đã chọn
            selectedChat.forEach(item => {
                appendMessage(item.sender, item.text, item.className);
                if (item.images && item.images.length > 0) {
                    item.images.forEach(imgUrl => appendImage(imgUrl));
                }
            });

            // Cập nhật lại tên đoạn chat hiện tại và các tin nhắn để tiếp tục nếu cần
            currentChatName = history[index].firstMessage;
            currentChatMessages = selectedChat;
        }
    </script>
</body>

</html>
